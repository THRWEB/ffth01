  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // ✅ তোমার নতুন ফায়ারবেস কনফিগ (Project: ffth01)
    const firebaseConfig = {
      apiKey: "AIzaSyB1vzDj_3-tymzU-EomjCIlbMhsoSnDiTU",
      authDomain: "ffth01.firebaseapp.com",
      projectId: "ffth01",
      storageBucket: "ffth01.firebasestorage.app",
      messagingSenderId: "879174774047",
      appId: "1:879174774047:web:386e99dd5c947381c4142a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authForm = document.getElementById('authForm');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const referralInput = document.getElementById('referralInput');
    const referralGroup = document.getElementById('referralGroup');
    const submitBtn = document.getElementById('submitBtn');
    const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
    const toggleAuthLink = document.getElementById('toggleAuthLink');
    const formTitle = document.getElementById('formTitle');
    const msg = document.getElementById('msg');
    const spinner = document.querySelector('.loading-spinner');
    const passwordGroup = document.getElementById('passwordGroup');

    let mode = 'login';

    function setLoading(isLoading) {
      spinner.style.display = isLoading ? 'block' : 'none';
      submitBtn.disabled = isLoading;
      forgotPasswordBtn.disabled = isLoading;
      toggleAuthLink.style.pointerEvents = isLoading ? 'none' : 'auto';
    }

    function setMessage(text = '', type = '') {
      msg.textContent = text;
      msg.className = 'min-h-[1.5rem] mt-4 text-center font-semibold';
      if (type === 'error') msg.classList.add('text-red-400');
      else if (type === 'success') msg.classList.add('text-emerald-400');
      else msg.classList.add('text-yellow-400');
    }

    toggleAuthLink.addEventListener('click', () => {
      setMessage();
      authForm.reset();
      passwordGroup.style.display = 'block'; 
      if (mode === 'login') {
        mode = 'signup';
        formTitle.textContent = 'Create a New Account';
        submitBtn.textContent = 'Sign Up';
        forgotPasswordBtn.style.display = 'none';
        referralGroup.style.display = 'block';
        toggleAuthLink.textContent = 'Already have an account? Login here';
      } else {
        mode = 'login';
        formTitle.textContent = 'Login to FFTW';
        submitBtn.textContent = 'Login';
        forgotPasswordBtn.style.display = 'block';
        referralGroup.style.display = 'none';
        toggleAuthLink.textContent = 'New user? Sign up here';
      }
    });

    forgotPasswordBtn.addEventListener('click', () => {
      mode = 'reset';
      formTitle.textContent = 'Reset Your Password';
      submitBtn.textContent = 'Send Reset Email';
      forgotPasswordBtn.style.display = 'none';
      referralGroup.style.display = 'none';
      toggleAuthLink.textContent = 'Back to Login';
      passwordGroup.style.display = 'none';
      setMessage();
      authForm.reset();
      emailInput.focus();
    });

    authForm.onsubmit = async (e) => {
      e.preventDefault();
      setMessage();

      const email = emailInput.value.trim();
      const password = passwordInput.value;
      const referCodeEntered = referralInput.value.trim().toUpperCase();

      if (!email) return setMessage('Please enter your email.', 'error');
      if (mode !== 'reset' && !password) return setMessage('Please enter your password.', 'error');

      setLoading(true);

      try {
        if (mode === 'login') {
          await signInWithEmailAndPassword(auth, email, password);
          setMessage('Login successful!', 'success');
          setTimeout(() => window.location.href = 'index.html', 1000);
        } 
        else if (mode === 'signup') {
          let referrerUID = null;

          if (referCodeEntered) {
            const q = query(collection(db, "users"), where("referCode", "==", referCodeEntered));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
              referrerUID = querySnapshot.docs[0].id;
            } else {
              setLoading(false);
              return setMessage('Invalid Referral Code!', 'error');
            }
          }

          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;

          const namePart = email.split('@')[0].substring(0, 3).toUpperCase();
          const randomPart = Math.floor(100 + Math.random() * 900);
          const myReferCode = namePart + randomPart;

          // ✅ প্রোফাইল ডেটা (app-ui.js এর সাথে সিঙ্ক করা)
          await setDoc(doc(db, "users", user.uid), {
            uid: user.uid,
            email: user.email,
            username: email.split('@')[0],
            referCode: myReferCode,
            referredBy: referrerUID,
            deposit: 0,
            winnings: 0,
            playedMatches: 0,
            profilePic: "https://cdn-icons-png.flaticon.com/512/1144/1144760.png", // ডিফল্ট ডিপি
            createdAt: new Date()
          });

          setMessage('Signup successful!', 'success');
          setTimeout(() => window.location.href = 'index.html', 1000);
        } 
        else if (mode === 'reset') {
          await sendPasswordResetEmail(auth, email);
          setMessage('Reset email sent! Check inbox.', 'success');
        }
      } catch (err) {
        setMessage(err.message, 'error');
      } finally {
        setLoading(false);
      }
    }
  </script>
