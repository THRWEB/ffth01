<style>
    #matchCard { 
      border-radius: 1.3rem; 
      border-left: 6px solid #10b981;
      background: rgba(30, 41, 59, 0.4);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .match-title { text-shadow: 0 2px 12px #08080866; }
    .es-value { font-weight: 800; color: #4ade80; }
    
    button:disabled {
      background: #1e293b !important;
      color: #64748b !important;
      cursor: not-allowed !important;
      opacity: 0.7;
    }

    .input-field {
      width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px;
      background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(16, 185, 129, 0.3);
      color: white; outline: none; transition: 0.3s;
    }
    .input-field:focus { border-color: #10b981; }
</style>

<main class="max-w-md mx-auto px-4 py-4">
    <div id="matchCard" class="px-4 pt-4 pb-4 mb-6 relative overflow-hidden">
      <div class="flex items-center gap-4">
        <img id="matchImage" src="" class="rounded-lg object-cover w-16 h-16 border-2 border-emerald-800 shadow" />
        <div id="matchTitle" class="match-title text-gray-100 text-lg font-bold">Loading...</div>
      </div>
      <div id="matchInfoContainer" class="mt-4 space-y-1.5 text-sm"></div>
    </div>

    <div class="p-5 bg-slate-800/30 rounded-2xl border border-white/10 backdrop-blur-lg">
      <h3 class="text-lg font-bold mb-2 text-emerald-400">Enter Player Name(s)</h3>
      <div id="nameFields"></div>
      <p id="feeInfo" class="mt-2 text-lg font-semibold text-yellow-400"></p>
      <button id="joinBtn" class="mt-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold py-3 px-4 rounded-xl w-full shadow-lg transition-all active:scale-95 uppercase">
        Join Match
      </button>
      <div id="message" class="text-center mt-4 font-semibold text-sm"></div>
    </div>

    <section class="bg-red-900/10 border-l-4 border-red-600 p-5 rounded-2xl my-6">
      <h3 class="text-red-500 font-bold text-lg mb-2 flex items-center gap-2">‚ö†Ô∏è Match Rules</h3>
      <ul class="text-xs text-gray-300 space-y-2 list-disc list-inside">
        <li>No hacks or mod apps. Permanent Ban if found.</li>
        <li>Level 15+ Free Fire ID required.</li>
        <li class="text-yellow-200 italic">Record gameplay for refund disputes.</li>
      </ul>
    </section>

    <div class="mt-8 pb-10">
        <h3 class="text-lg font-bold mb-4 text-emerald-400">Joined Players</h3>
        <div id="playerListContainer" class="grid grid-cols-2 gap-2 text-sm"></div>
    </div>
</main>

<script type="module">
    import { doc, onSnapshot, runTransaction, arrayUnion } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    (function() {
        // match-list ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ Match ID ‡¶®‡ßá‡¶ì‡ßü‡¶æ
        const matchId = localStorage.getItem('matchId');
        const db = window.db;
        const user = window.auth.currentUser;

        if (!matchId || !user) {
            router.navigate('home');
            return;
        }

        let entryFee = 0, maxNames = 1, matchTimeRaw = null;

        // ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∞‡¶ø‡ßü‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶≤‡ßã‡¶°
        const unsub = onSnapshot(doc(db, "allMatches", matchId), (snap) => {
            if (!document.getElementById('matchTitle')) { unsub(); return; }
            if (!snap.exists()) return;

            const data = snap.data();
            entryFee = Number(data.entry) || 0;
            matchTimeRaw = data.time;
            
            const cat = (data.category || "").toLowerCase();
            maxNames = cat.includes('solo') ? 1 : cat.includes('duo') ? 2 : 4;

            document.getElementById('matchTitle').textContent = data.title;
            document.getElementById('matchImage').src = data.image || "https://i.postimg.cc/rsf7yB1M/1768308154801.jpg";
            
            const displayTime = window.formatMatchTime ? window.formatMatchTime(data.time) : "TBA";
            document.getElementById('matchInfoContainer').innerHTML = `
                <div class="flex justify-between text-gray-400"><span>Entry Fee:</span><span class="es-value">‚Çπ${data.entry || 0}</span></div>
                <div class="flex justify-between text-gray-400"><span>Prize:</span><span class="es-value">‚Çπ${data.prize || 0}</span></div>
                <div class="flex justify-between text-gray-400"><span>Time:</span><span class="es-value">${displayTime}</span></div>
                <div class="flex justify-between text-gray-400"><span>Map:</span><span class="es-value">${data.map || 'Bermuda'}</span></div>
                <div class="flex justify-between text-gray-400"><span>Slots Left:</span><span class="es-value text-red-400">${data.slot || 0}</span></div>
            `;

            renderNameFields(maxNames);
            updateFeeInfo();
            checkEntryStatus(matchTimeRaw);

            document.getElementById('playerListContainer').innerHTML = (data.joinedPlayers || []).map(p => 
                `<div class="bg-slate-800/40 p-2 rounded-lg border border-white/5">üéÆ ${p.name}</div>`
            ).join('');
        });

        function renderNameFields(max) {
            const div = document.getElementById('nameFields');
            if (div.children.length > 0) return;
            for (let i = 0; i < max; i++) {
                const inp = document.createElement('input');
                inp.placeholder = `Player ${i+1}${i === 0 ? ' (Required)' : ' (Optional)'}`;
                inp.className = "input-field";
                inp.oninput = updateFeeInfo;
                div.appendChild(inp);
            }
        }

        function updateFeeInfo() {
            const inputs = document.querySelectorAll('#nameFields input');
            const filled = [...inputs].filter(f => f.value.trim()).length;
            const count = filled > 0 ? filled : 1;
            document.getElementById("feeInfo").textContent = `Total Fee: ‚Çπ${entryFee * count}`;
        }

        function checkEntryStatus(time) {
            const matchTimestamp = time.seconds ? time.seconds * 1000 : Number(time);
            if ((matchTimestamp - Date.now()) <= 60000) {
                const btn = document.getElementById('joinBtn');
                btn.disabled = true;
                btn.innerText = "Entry Closed";
            }
        }

        document.getElementById('joinBtn').onclick = async () => {
            const names = [...document.querySelectorAll('#nameFields input')].map(i => i.value.trim()).filter(Boolean);
            if (names.length < 1) return alert("Enter player name.");

            const btn = document.getElementById('joinBtn');
            btn.disabled = true;
            btn.innerText = "Processing...";

            const totalCost = entryFee * names.length;

            try {
                await runTransaction(db, async (tx) => {
                    const userRef = doc(db, "users", user.uid);
                    const matchRef = doc(db, "allMatches", matchId);
                    const uSnap = await tx.get(userRef);
                    const mSnap = await tx.get(matchRef);

                    const userData = uSnap.data();
                    const matchData = mSnap.data();
                    const balance = (userData.deposit || 0) + (userData.winnings || 0);

                    if (balance < totalCost) throw "Insufficient balance!";
                    if ((matchData.slot || 0) < names.length) throw "Not enough slots!";

                    let dep = userData.deposit || 0;
                    let win = userData.winnings || 0;
                    let newDep = Math.max(0, dep - totalCost);
                    let rem = totalCost - (dep - newDep);
                    let newWin = win - rem;

                    tx.update(userRef, { deposit: newDep, winnings: newWin });
                    tx.update(matchRef, { 
                        slot: matchData.slot - names.length, 
                        joinedPlayers: arrayUnion(...names.map(n => ({ uid: user.uid, name: n }))) 
                    });
                });
                alert("Joined Successfully!");
                router.navigate('mymatches');
            } catch (e) {
                alert("Error: " + e);
                btn.disabled = false;
                btn.innerText = "Join Match";
            }
        };
    })();
</script>
