<style>
    /* তোমার পছন্দের সেই সুন্দর কার্ড ডিজাইন */
    #matchCard { 
      border-radius: 1.3rem; 
      border-left: 6px solid #10b981;
      background: linear-gradient(to bottom right, #1e293b, #0f172a);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .es-value { font-weight: 800; color: #4ade80; }
    .match-title { text-shadow: 0 2px 12px #08080866; }
    
    /* Animation for smooth loading */
    .fade-in-up {
      animation: fadeInUp 0.4s ease-out forwards;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
</style>

<main class="max-w-md mx-auto px-3 py-4">
    <div id="matchContainer" class="space-y-4">
        <p id="loadingText" class="text-center text-gray-400 mt-10 animate-pulse">Loading matches...</p>
    </div>
</main>

<script type="module">
    // Firebase Firestore functions import
    import { collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    (function() {
        const container = document.getElementById('matchContainer');
        const categoryId = localStorage.getItem('currentCat');

        // ১. ক্যাটাগরি চেক
        if (!categoryId) {
            container.innerHTML = `
                <div class="text-center mt-10">
                    <p class="text-red-400 font-bold text-lg">No Category Selected!</p>
                    <p class="text-gray-500 text-sm">Please go back to Home.</p>
                </div>`;
            return;
        }

        // ২. ডাটাবেস কানেকশন চেক (Firebase app initialized থাকতে হবে)
        // যদি window.db কাজ না করে, তবে নিশ্চিত করুন firebase-init ফাইলে window.db = db; করা আছে।
        const db = window.db; 
        if (!db) {
            console.error("Firestore Database (window.db) not found!");
            container.innerHTML = '<p class="text-center text-orange-400 mt-10">Database connection error!</p>';
            return;
        }

        const matchCollection = collection(db, "allMatches");

        // ৩. রিয়েল-টাইম লিসেনার
        onSnapshot(matchCollection, (snapshot) => {
            if (!container) return;
            
            let htmlContent = '';
            let count = 0;

            if (snapshot.empty) {
                container.innerHTML = '<p class="text-center text-gray-500 mt-20 italic">No matches available in database!</p>';
                return;
            }

            snapshot.forEach((doc) => {
                const match = doc.data();
                const matchId = doc.id;
                
                // ৪. ক্যাটাগরি ফিল্টারিং (Case Insensitive)
                const targetCat = categoryId.toLowerCase().trim();
                const matchCat = match.category ? match.category.toString().toLowerCase().trim() : "";

                if (matchCat === targetCat) {
                    count++;
                    
                    // টাইম ফরম্যাট চেক
                    const matchDisplayTime = window.formatMatchTime ? window.formatMatchTime(match.time) : (match.time || "TBA");
                    
                    htmlContent += `
                        <div id="matchCard" class="relative overflow-hidden fade-in-up">
                          <div class="flex items-center gap-3">
                            <img src="${match.image || 'https://i.postimg.cc/rsf7yB1M/1768308154801.jpg'}" 
                                 class="rounded-lg object-cover w-16 h-16 border-2 border-emerald-800 shadow" 
                                 onerror="this.src='https://i.postimg.cc/rsf7yB1M/1768308154801.jpg'"/>
                            <div class="match-title text-gray-100 text-lg font-bold">${match.title || 'Tournament'}</div>
                          </div>
                          
                          <div class="mt-4 space-y-1.5 text-sm">
                            <div class="flex justify-between text-gray-400"><span>Entry Fee:</span><span class="es-value">₹${match.entry || 0}</span></div>
                            <div class="flex justify-between text-gray-400"><span>Prize:</span><span class="es-value">₹${match.prize || 0}</span></div>
                            <div class="flex justify-between text-gray-400"><span>Time:</span><span class="es-value">${matchDisplayTime}</span></div>
                            <div class="flex justify-between text-gray-400"><span>Map:</span><span class="es-value">${match.map || 'Bermuda'}</span></div>
                            <div class="flex justify-between text-gray-400"><span>Slots Left:</span><span class="es-value text-red-400">${match.slot || 0}</span></div>
                          </div>

                          <button onclick="localStorage.setItem('matchId', '${matchId}'); router.navigate('match-details')" 
                            class="mt-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold py-3 rounded-xl w-full shadow-lg transition-all active:scale-95 uppercase text-sm">
                            Match Details
                          </button>
                        </div>`;
                }
            });

            // ৫. রেজাল্ট রেন্ডার
            if (count === 0) {
                container.innerHTML = `
                    <div class="text-center mt-20">
                        <p class="text-gray-500 italic font-bold">No active matches for "${categoryId.toUpperCase()}"</p>
                    </div>`;
            } else {
                container.innerHTML = htmlContent;
            }
        }, (error) => {
            console.error("Firestore Error:", error);
            container.innerHTML = '<p class="text-center text-red-400 mt-10">Error loading matches. Check console.</p>';
        });
    })();
</script>
